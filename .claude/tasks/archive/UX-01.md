# UX-01: Address Autocomplete

## Overview
| Field | Value |
|-------|-------|
| **Task ID** | UX-01 |
| **Title** | Address Autocomplete |
| **Status** | DONE |
| **Priority** | Low |
| **Estimated Complexity** | Easy |
| **Dependencies** | None |
| **Completed** | 2026-02-04 |

---

## Description

Add Google Places autocomplete to address fields for better UX. When users start typing an address, show suggestions and auto-fill street, city, state, zip when selected.

---

## Requirements

### Functional Requirements

1. **Autocomplete Input**
   - Replace street address input with autocomplete
   - Show dropdown suggestions as user types
   - Support US addresses only

2. **Auto-Fill on Selection**
   - When address selected, populate:
     - Street address
     - City
     - State
     - ZIP code
   - Unit/apt number remains manual entry

3. **Fallback**
   - Manual entry still works if autocomplete fails
   - Works without API key (degraded mode)

4. **Apply to All Address Fields**
   - Current residence (AddressForm)
   - Subject property (PropertyForm)
   - Mailing address if different

### Non-Functional Requirements

- Debounce API calls (300ms)
- Loading indicator while fetching
- Keyboard navigation support
- Mobile-friendly dropdown

---

## Acceptance Criteria

- [x] Typing address shows autocomplete suggestions
- [x] Selecting suggestion fills all address fields
- [x] Works on current address step
- [x] Works on property address step
- [x] Keyboard navigation works (up/down/enter)
- [x] Manual entry still possible
- [x] Mobile responsive

---

## Files to Create

| File | Purpose |
|------|---------|
| `src/components/AddressAutocomplete.tsx` | Reusable autocomplete component |
| `src/pages/api/places/autocomplete.ts` | Proxy API to hide API key |

## Files to Modify

| File | Change |
|------|--------|
| `src/components/steps/AddressForm.tsx` | Use AddressAutocomplete |
| `src/components/steps/PropertyForm.tsx` | Use AddressAutocomplete |
| `.env.example` | Add Google Places API key template |

---

## Technical Notes

### Option 1: Google Places API (Recommended)
```bash
# .env.local
GOOGLE_PLACES_API_KEY=your_api_key_here
```

Free tier: 28,500 requests/month (sufficient for demo)

### Option 2: Free Alternatives
- **Nominatim** (OpenStreetMap) - Free, no API key
- **Geoapify** - Free tier available
- **SmartyStreets** - Free tier (250 lookups/month)

### Proxy API (hides API key)
```typescript
// pages/api/places/autocomplete.ts
export default async function handler(req, res) {
  const { input } = req.query

  const response = await fetch(
    `https://maps.googleapis.com/maps/api/place/autocomplete/json?` +
    `input=${encodeURIComponent(input)}&` +
    `types=address&` +
    `components=country:us&` +
    `key=${process.env.GOOGLE_PLACES_API_KEY}`
  )

  const data = await response.json()
  res.json(data.predictions)
}
```

### Component Pattern
```tsx
// components/AddressAutocomplete.tsx
import { useState, useEffect, useRef } from 'react'
import { useDebounce } from '../hooks/useDebounce'

type Props = {
  value: string
  onChange: (value: string) => void
  onSelect: (address: ParsedAddress) => void
  placeholder?: string
}

type ParsedAddress = {
  street: string
  city: string
  state: string
  zip: string
}

export default function AddressAutocomplete({ value, onChange, onSelect, placeholder }: Props) {
  const [suggestions, setSuggestions] = useState([])
  const [isOpen, setIsOpen] = useState(false)
  const [loading, setLoading] = useState(false)
  const debouncedValue = useDebounce(value, 300)

  useEffect(() => {
    if (debouncedValue.length < 3) {
      setSuggestions([])
      return
    }

    async function fetchSuggestions() {
      setLoading(true)
      const res = await fetch(`/api/places/autocomplete?input=${encodeURIComponent(debouncedValue)}`)
      const data = await res.json()
      setSuggestions(data)
      setIsOpen(true)
      setLoading(false)
    }

    fetchSuggestions()
  }, [debouncedValue])

  async function handleSelect(placeId: string, description: string) {
    // Fetch place details to get structured address
    const res = await fetch(`/api/places/details?place_id=${placeId}`)
    const details = await res.json()

    onSelect({
      street: details.street,
      city: details.city,
      state: details.state,
      zip: details.zip
    })
    setIsOpen(false)
  }

  return (
    <div className="relative">
      <input
        type="text"
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder}
        className="input"
      />
      {loading && <span className="absolute right-3 top-3">...</span>}
      {isOpen && suggestions.length > 0 && (
        <ul className="absolute z-10 w-full bg-white border rounded-lg shadow-lg mt-1 max-h-60 overflow-auto">
          {suggestions.map((s) => (
            <li
              key={s.place_id}
              onClick={() => handleSelect(s.place_id, s.description)}
              className="px-4 py-2 hover:bg-gray-100 cursor-pointer"
            >
              {s.description}
            </li>
          ))}
        </ul>
      )}
    </div>
  )
}
```

### Usage in AddressForm
```tsx
<AddressAutocomplete
  value={street}
  onChange={setStreet}
  onSelect={(addr) => {
    setStreet(addr.street)
    setCity(addr.city)
    setState(addr.state)
    setZip(addr.zip)
  }}
  placeholder="Start typing address..."
/>
```

---

## Testing

### Manual Testing
1. Go to Address step
2. Start typing "123 Main"
3. See dropdown suggestions appear
4. Select an address
5. Verify all fields populate
6. Test keyboard navigation (arrows + enter)
7. Test on mobile

### Edge Cases
- Very long addresses
- Addresses with unit numbers
- PO Boxes (may not autocomplete)
- Addresses not in Google (fallback to manual)

---

## Design Reference

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Street Address                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ 123 Main St, Austin                          ğŸ” â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸ“ 123 Main St, Austin, TX 78701               â”‚    â”‚
â”‚  â”‚ ğŸ“ 123 Main St, Austin, TX 78702               â”‚    â”‚
â”‚  â”‚ ğŸ“ 123 Main Street, Austin, TX 78703           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  Unit/Apt (optional)                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  City              State         ZIP                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Austin     â”‚   â”‚ TX   â–¼  â”‚   â”‚ 78701    â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  (auto-filled)    (auto-filled) (auto-filled)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Environment Setup

Add to `.env.local`:
```
GOOGLE_PLACES_API_KEY=your_api_key_here
```

Get API key at: https://console.cloud.google.com/apis/credentials
Enable: Places API, Geocoding API
